From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Yive <6853318+Yive@users.noreply.github.com>
Date: Tue, 27 Aug 2024 01:53:59 -0700
Subject: [PATCH] Prevent x-ray exploits when players are inside certain blocks


diff --git a/src/main/java/dev/yive/pluto/PlutoConfig.java b/src/main/java/dev/yive/pluto/PlutoConfig.java
index e6b6378f81e18e25bbfd4a987b22d2cbef976ca7..aec0c5d373574cf674b97b99c8f25364bcd41195 100644
--- a/src/main/java/dev/yive/pluto/PlutoConfig.java
+++ b/src/main/java/dev/yive/pluto/PlutoConfig.java
@@ -397,5 +397,10 @@ public class PlutoConfig {
         private void entityRainCheckModulo() {
             entityRainCheckRate = Math.min(1, getInt("entities.global.rain-check-tick-rate", entityRainCheckRate));
         }
+
+        public boolean preventInsideBlockXrayExploit = false;
+        private void disableInsideBlockXrayExploit() {
+            preventInsideBlockXrayExploit = getBoolean("entities.player.prevent-xray-exploits-inside-certain-blocks", preventInsideBlockXrayExploit);
+        }
     }
 }
diff --git a/src/main/java/net/minecraft/world/entity/item/FallingBlockEntity.java b/src/main/java/net/minecraft/world/entity/item/FallingBlockEntity.java
index b83be9bbb9f348da83c0fd1ecc7f65c8a58b45b9..fa9b5fc2dd8eddbe191eaed0a61c9ecb447d92c4 100644
--- a/src/main/java/net/minecraft/world/entity/item/FallingBlockEntity.java
+++ b/src/main/java/net/minecraft/world/entity/item/FallingBlockEntity.java
@@ -204,6 +204,21 @@ public class FallingBlockEntity extends Entity {
                                     this.discard(EntityRemoveEvent.Cause.DESPAWN); // SPIGOT-6586 called before the event in previous versions
                                     return;
                                 }
+
+                                // Pluto start - Prevent x-ray exploits when players are inside certain blocks
+                                if (this.level().plutoConfig().preventInsideBlockXrayExploit) {
+                                    org.bukkit.Material material = this.level().getBlockState(blockposition.below()).getBukkitMaterial();
+                                    if (material == org.bukkit.Material.COMPOSTER || material.toString().contains("CAULDRON")) { // Yes I know this is terrible
+                                        this.discard(EntityRemoveEvent.Cause.DESPAWN);
+                                        if (this.dropItem && this.level().getGameRules().getBoolean(GameRules.RULE_DOENTITYDROPS)) {
+                                            this.callOnBrokenAfterFall(block, blockposition);
+                                            this.spawnAtLocation(block);
+                                        }
+                                        return;
+                                    }
+                                }
+                                // Pluto end - Prevent x-ray exploits when players are inside certain blocks
+
                                 // CraftBukkit end
                                 if (this.level().setBlock(blockposition, this.blockState, 3)) {
                                     ((ServerLevel) this.level()).getChunkSource().chunkMap.broadcast(this, new ClientboundBlockUpdatePacket(blockposition, this.level().getBlockState(blockposition)));
